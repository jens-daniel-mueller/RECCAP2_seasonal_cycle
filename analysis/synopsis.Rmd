---
title: "Synopsis"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r set_options_global, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r define_paths}

path_reccap2 <-
  "/nfs/kryo/work/updata/reccap2/"

path_synoptic_datasets <-
  "/nfs/kryo/work/updata/reccap2/synoptic_datasets/"

```

```{r load_libraries_specific, include=FALSE}
library(tidyverse)
library(collapse)
library(patchwork)
library(stars)
library(lubridate)
library(gsw)
library(marelac)
library(colorspace)
```


```{r set_ggplot_theme_global, include = FALSE}
theme_set(theme_bw())
```



byte open_ocean[lon,lat]   (Contiguous storage)  
    region_name: 1.Atlantic, 2.Pacific, 3.Indian, 4.Arctic, 5.Southern
byte atlantic[lon,lat]   (Contiguous storage)  
    region_name: 1.NA SPSS, 2.NA STSS, 3.NA STPS, 4.AEQU, 5.SA STPS, 6.MED (not in FM14)
byte pacific[lon,lat]   (Contiguous storage)  
    region_name: 1.NP SPSS, 2.NP STSS, 3.NP STPS, 4.PEQU-W, 5.PEQU-E, 6.SP STPS
byte indian[lon,lat]   (Contiguous storage)  
    region_name: 1.Arabian Sea, 2.Bay of Bengal, 3.Equatorial Indian, 4.Southern Indian
byte arctic[lon,lat]   (Contiguous storage)  
    region_name: 1.ARCTIC ICE (not in FM14), 2.NP ICE, 3.NA ICE, 4.Barents (not in FM14)
byte southern[lon,lat]   (Contiguous storage)  
    region_name: 1.SO STSS, 2.SO SPSS, 3.SO ICE




```{r read files}

surface_co2 <-
  read_csv(
    file = paste(
      path_synoptic_datasets,
      "surface_co2_surface_biome_averages",
      ".csv",
      sep = ""
    )
  )

surface_co2 <- surface_co2 %>% 
  filter(model != "NIES-ML3_v20220222")

models <-
  read_csv(
    file = paste(
      path_synoptic_datasets,
      "models_surface_biome_averages",
      ".csv",
      sep = ""
    )
  )

biome_averages <- bind_rows(
  surface_co2 %>% mutate(class = "surface_co2"),
  models %>% mutate(class = "models")
)

biome_averages <- biome_averages  %>% 
  mutate(biome = case_when(
    biome == "atlantic_1" ~ "NA SPSS",
    biome == "atlantic_3" ~ "NA STPS",
    biome == "southern_1" ~ "SO STSS",
    biome == "southern_2" ~ "SO SPSS",
    TRUE ~ "other"
  )) %>% 
  filter(biome != "other")

amplitudes <-
  biome_averages %>%
  select(year, month, biome, class, model, fgco2, fgco2_reg, spco2) %>% 
  pivot_longer(fgco2:spco2,
               names_to = "parameter",
               values_to = "value") %>% 
  group_by(class, model, year, biome, parameter) %>%
  summarise(min = min(value),
            max = max(value),
            amplitude = max - min) %>%
  ungroup()


pdf("output/amplitude_time_series.pdf",
    width = 10,
    height = 10)
amplitudes %>%
  group_split(parameter) %>%
  # head(1) %>% 
  map(
    ~ ggplot(data = .x,
             aes(year, amplitude)) +
      geom_path(aes(col = model)) +
      geom_smooth(method = "lm", col="black", se=FALSE) +
      labs(y = .x$parameter,
           title = "Seasonal amplitude (annual max - min)") +
      scale_color_discrete(name = "product") +
      facet_grid(biome ~ class, scales = "free_y")
  )
dev.off()


pdf("output/min_max_time_series.pdf",
    width = 10,
    height = 10)
amplitudes %>%
  select(-amplitude) %>%
  pivot_longer(min:max,
               names_to = "extreme",
               values_to = "value") %>%
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, value, linetype = extreme)) +
      geom_path(aes(col = model)) +
      geom_smooth(method = "lm", col = "black", se = FALSE) +
      labs(y = .x$parameter,
           title = "Annual max & min") +
      scale_color_discrete(name = "product") +
      facet_grid(biome ~ class, scales = "free_y")
  )
dev.off()

```


